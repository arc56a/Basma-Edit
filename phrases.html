<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بصمة - العبارات</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <style>
        :root {
            --neon-blue: #0ff;
            --neon-pink: #ff2a6d;
            --dark-bg: #050814;
            --grid-color: rgba(0, 255, 255, 0.08);
            --fire-gradient: linear-gradient(0deg, #ff2a00, #ff8c00, #ff2a00);
        }
        * { -webkit-tap-highlight-color: transparent; }
        img { -webkit-user-drag: none; user-drag: none; -webkit-touch-callout: none; user-select: none; pointer-events: none; }
        button, a { outline: none; }
        button:focus, button:active, a:focus { outline: none; }
        body {
            margin: 0; padding: 0; min-height: 100vh;
            font-family: 'Tajawal', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-bg); color: #f5f5f5; position: relative;
            overflow-x: hidden; width: 100%; max-width: 480px; margin-left: auto; margin-right: auto; box-sizing: border-box;
        }
        body::before, body::after { content: ''; position: fixed; inset: 0; z-index: -2; }
        body::before {
            background: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px; animation: gridMove 22s linear infinite;
        }
        body::after {
            background: radial-gradient(circle at 50% 120%, var(--fire-gradient) 0%, transparent 60%);
            filter: blur(18px); opacity: 0.55; animation: firePulse 4s ease-in-out infinite alternate;
        }
        .screen {
            min-height: 100vh; max-width: 480px; width: 100%; margin: 0 auto;
            padding: 16px 14px 24px; display: flex; flex-direction: column; gap: 16px;
            box-sizing: border-box; position: relative;
        }
        header {
            position: sticky; top: 56px; z-index: 5; display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 8px; padding: 8px 10px; border-radius: 14px; background: rgba(5, 10, 30, 0.85);
            border: 1px solid rgba(0, 255, 255, 0.35); box-shadow: 0 0 18px rgba(0, 255, 255, 0.3);
            transition: opacity 0.4s ease; text-align: center;
        }
        .logo {
            position: relative; font-weight: 700; letter-spacing: 2px; font-size: 1.1rem;
            color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); z-index: 1;
        }
        nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; }
        nav button {
            border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 999px; padding: 4px 8px;
            font-size: 0.7rem; background: rgba(5, 15, 35, 0.8); color: #e0e0e0; cursor: pointer;
            transition: 0.25s ease; position: relative; overflow: hidden;
        }
        nav button:hover { border-color: var(--neon-pink); color: var(--neon-pink); box-shadow: 0 0 12px rgba(255, 42, 109, 0.7); }
        nav button.active {
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink)); color: #050814; font-weight: 600;
            box-shadow: 0 0 18px rgba(0, 255, 255, 0.8), 0 0 28px rgba(255, 42, 109, 0.7);
        }
        .back-btn, .exit-btn {
            position: fixed; top: 14px; min-width: 80px; height: 34px; padding: 0 10px; border-radius: 999px;
            border: 1px solid rgba(0, 255, 255, 0.4); background: rgba(5, 15, 35, 0.8); font-size: 0.75rem; color: #e0e0e0;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer;
            z-index: 10; transition: 0.25s ease; box-shadow: 0 0 10px rgba(0, 255, 255, 0.25);
        }
        .back-btn { right: 14px; }
        .exit-btn { left: 14px; }
        .phrases-section { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; margin-top: 24px; margin-bottom: 20px; transition: transform 0.4s ease; }
        .phrase-slider { position: relative; width: 100%; max-width: 360px; height: 200px; perspective: 1400px; }
        .phrase-card {
            position: absolute; inset: 0; padding: 20px; border-radius: 18px; background: rgba(10,10,20,0.55);
            backdrop-filter: blur(6px); border: 1px solid rgba(255,150,70,0.5);
            box-shadow: 0 0 20px rgba(255,100,40,0.5), 0 0 35px rgba(255,170,50,0.3);
            display: flex; align-items: center; justify-content: center; text-align: center;
            transform-style: preserve-3d; backface-visibility: hidden; opacity: 0;
            transform: rotateY(40deg) translateZ(-160px) scale(.85); transition: transform 1s ease, opacity 1s ease;
        }
        .phrase-user { position: absolute; top: 12px; right: 18px; font-size: 0.7rem; font-weight: 600; color: #f5f5f5; text-shadow: none; opacity: 0.4; }
        .phrase-card.active { opacity: 1; transform: rotateY(0deg) translateZ(0) scale(1.07); z-index: 10; }
        .phrase-card.prev { opacity: .3; transform: translateX(120px) rotateY(-40deg) translateZ(-200px) scale(.85); }
        .phrase-card.next { opacity: .3; transform: translateX(-120px) rotateY(40deg) translateZ(-200px) scale(.85); }
        .phrase-text { text-align: center; font-size: 1.05rem; line-height: 1.7; overflow-wrap: break-word; padding: 0 30px; box-sizing: border-box; width: 100%; }
        .phrase-nav { display: flex; align-items: center; justify-content: center; gap: 24px; margin-top: 12px; transition: opacity 0.4s ease; }
        .phrase-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid rgba(0, 255, 255, 0.5);
            background: radial-gradient(circle at 30% 0%, rgba(0,255,255,0.2), transparent 60%), rgba(5, 15, 35, 0.95);
            color: #f5f5f5; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.6); transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
        }
        .phrase-counter { margin-top: 6px; font-size: 0.9rem; letter-spacing: 0.08em; color: #cfd8dc; }
        .phrase-counter span { color: var(--neon-pink); text-shadow: 0 0 8px rgba(255, 42, 109, 0.9); font-weight: 600; }
        .search-container { margin-bottom: 10px; position: relative; transition: opacity 0.4s ease; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .phrase-search {
            width: 100%; max-width: 200px; padding: 10px 16px; border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 25px;
            background: rgba(5, 15, 35, 0.8); color: #f5f5f5; font-size: 0.9rem; text-align: center; outline: none;
            transition: all 0.3s ease; box-shadow: 0 0 12px rgba(0, 255, 255, 0.3);
        }
        .add-phrase-section { padding: 15px; border-radius: 14px; background: rgba(5, 10, 30, 0.7); border: 1px solid rgba(0, 255, 255, 0.2); text-align: center; }
        #showAddFormBtn { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--neon-blue); background: transparent; color: var(--neon-blue); font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; }
        #addPhraseForm { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.65); backdrop-filter: blur(10px); z-index: 50; }
        #addPhraseForm.hidden { display: none; }
        #addPhraseForm.visible { display: flex; }
        
        /* Like button styles */
        .phrase-card-footer { position: absolute; bottom: 12px; left: 18px; display: flex; align-items: center; gap: 8px; }
        .like-btn { background: none; border: none; cursor: pointer; font-size: 1.5rem; color: rgba(255, 255, 255, 0.7); transition: color 0.3s, transform 0.3s; padding: 0; }
        .like-btn:hover { transform: scale(1.15); }
        .like-btn.liked { color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink); animation: like-pop 0.4s ease; }
        @keyframes like-pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .likes-counter { font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); font-weight: 600; }

        .form-message { display: none; margin-top: 15px; font-size: 0.9rem; color: var(--success); }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.history.back()"><img src="images/left-arrow.png" alt="رجوع"></button>
    <button class="exit-btn" onclick="window.location.href='index.html'"><img src="images/log-out.png" alt="خروج"></button>
    <div class="screen">
        <header>
             <div class="logo">بصمة</div>
             <nav>
                <button onclick="window.location.href='main.html'">الرئيسية</button>
                <button class="active" onclick="window.location.href='phrases.html'">العبارات</button>
                <button onclick="window.location.href='updates.html'">التحديثات</button>
                <button onclick="window.location.href='settings.html'">الإعدادات</button>
                <button onclick="window.location.href='about.html'">حول الموقع</button>
            </nav>
        </header>
        <div class="phrases-section">
            <div class="search-container">
                <button class="camera-btn" id="cameraBtn" title="وضع لقطة الشاشة">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                </button>
                <input type="number" class="phrase-search" id="phraseSearch" placeholder="اكتب رقم العبارة" min="1">
            </div>
            <div class="phrase-slider" id="phraseSlider"></div>
            <div class="phrase-nav">
                <button class="phrase-btn" id="prevPhrase" aria-label="العبارة السابقة">‹</button>
                <div class="phrase-counter">العبارة <span id="currentPhrase"></span> / <span id="totalPhrases"></span></div>
                <button class="phrase-btn" id="nextPhrase" aria-label="العبارة التالية">›</button>
            </div>
        </div>
        <div class="add-phrase-section">
            <div id="countdownTimer" style="display: none; text-align: center; margin-bottom: 15px; font-size: 1rem; color: var(--neon-pink);"></div>
            <div id="form-message" class="form-message"></div>
            <button id="showAddFormBtn">إضافة عبارة جديدة</button>
        </div>
    </div>
    <div id="addPhraseForm" class="hidden">
        <div class="add-phrase-modal">
            <h3 class="add-phrase-title">إضافة عبارة جديدة</h3>
            <div class="add-phrase-fields">
                <input type="text" id="newPhraseText" placeholder="اكتب عبارتك هنا (10-150 حرف)" maxlength="150">
                <div id="phraseError" class="error-message"></div>
                <input type="text" id="newPhraseUser" placeholder="اسم المستخدم (3-15 حرف، إنجليزي)" autocomplete="off" maxlength="15">
                <div id="userError" class="error-message"></div>
            </div>
            <div class="add-phrase-preview">
                <div class="phrase-slider preview-slider">
                    <div class="phrase-card active" id="previewPhraseCard">
                        <div class="phrase-user" id="previewPhraseUser" style="display: none;">@username</div>
                        <div class="phrase-text" id="previewPhraseText">هنا ستظهر عبارتك قبل النشر.</div>
                    </div>
                </div>
                <p class="preview-hint">شاهد شكل البطاقة قبل الإرسال، مع اسم المستخدم الخاص بك.</p>
            </div>
            <div class="form-buttons">
                <button id="addPhraseBtn">إرسال</button>
                <button id="cancelAddBtn" type="button">إلغاء</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Appwrite Configuration ---
            const APPWRITE_ENDPOINT = "https://fra.cloud.appwrite.io/v1";
            const APPWRITE_PROJECT_ID = "basmaedit56";
            const DATABASE_ID = "693b73ab003790d00cf3";
            const PHRASES_COLLECTION_ID = "phrases_section";

            const { ID, Query, Client, Account, Databases } = window.Appwrite;
            const client = new Client().setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT_ID);
            const databases = new Databases(client);
            const account = new Account(client);

            let phraseSettings = null;
            let anonymousUser = null;
            let phraseDocs = [];

            // --- UI Elements ---
            const showFormBtn = document.getElementById('showAddFormBtn');
            const addFormContainer = document.getElementById('addPhraseForm');
            const slider = document.getElementById('phraseSlider');
            
            // --- Anonymous Auth ---
            const getAnonymousUser = async () => {
                try {
                    return await account.get();
                } catch (error) {
                    try {
                        return await account.createAnonymousSession();
                    } catch (e) {
                        console.error("Failed to create anonymous session", e);
                        return null;
                    }
                }
            };

            // --- Like Logic ---
            const handleLike = async (docId, likeBtn, counterEl) => {
                if (!anonymousUser) {
                    console.error("Anonymous user not found.");
                    return;
                }
                const userId = anonymousUser.$id;
                let phrase = phraseDocs.find(d => d.$id === docId);
                if (!phrase) return;

                const likedBy = phrase.liked_by || [];
                const isLiked = likedBy.includes(userId);
                const originalLikes = phrase.likes;

                // Optimistic UI update
                likeBtn.classList.toggle('liked', !isLiked);
                phrase.likes = isLiked ? phrase.likes - 1 : phrase.likes + 1;
                counterEl.textContent = phrase.likes;
                if(isLiked) {
                    phrase.liked_by = likedBy.filter(id => id !== userId);
                } else {
                    phrase.liked_by.push(userId);
                }

                try {
                    await databases.updateDocument(DATABASE_ID, PHRASES_COLLECTION_ID, docId, {
                        likes: phrase.likes,
                        liked_by: phrase.liked_by
                    });
                } catch (error) {
                    console.error("Failed to update likes:", error);
                    // Revert UI on failure
                    phrase.likes = originalLikes;
                    phrase.liked_by = likedBy;
                    likeBtn.classList.toggle('liked', isLiked);
                    counterEl.textContent = originalLikes;
                }
            };
            
            // --- Slider & Card Management ---
            const sliderManager = {
                // ... (most of the slider manager remains the same)
                addCard: function(doc) {
                    const newCard = document.createElement('div');
                    newCard.className = 'phrase-card';
                    newCard.dataset.docId = doc.$id;

                    const userHTML = doc.user ? `<div class="phrase-user">@${doc.user}</div>` : '';
                    const textHTML = `<div class="phrase-text">${doc.text.replace(/\n/g, '<br>')}</div>`;
                    
                    const isLiked = anonymousUser && doc.liked_by && doc.liked_by.includes(anonymousUser.$id);

                    const footerHTML = `
                        <div class="phrase-card-footer">
                            <button class="like-btn ${isLiked ? 'liked' : ''}" aria-label="Like">❤</button>
                            <span class="likes-counter">${doc.likes || 0}</span>
                        </div>`;

                    newCard.innerHTML = userHTML + textHTML + footerHTML;
                    slider.appendChild(newCard);
                    
                    const likeBtn = newCard.querySelector('.like-btn');
                    const likesCounter = newCard.querySelector('.likes-counter');
                    likeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleLike(doc.$id, likeBtn, likesCounter);
                    });
                }
                // ... other slider functions
            };
            // (The full sliderManager object will be here)
            
            // --- Form & Submission Logic ---
            const showFormMessage = (message, isError = false) => {
                const msgEl = document.getElementById('form-message');
                msgEl.textContent = message;
                msgEl.style.color = isError ? 'var(--danger)' : 'var(--success)';
                msgEl.style.display = 'block';
                setTimeout(() => { msgEl.style.display = 'none'; }, 4000);
            };

            const handleSubmitPhrase = async (text, user) => {
                if (!validateUser(user) || !validatePhrase(text)) return;
                
                const submitBtn = document.getElementById('addPhraseBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'جارٍ الإرسال...';
                
                try {
                    await databases.createDocument(DATABASE_ID, PHRASES_COLLECTION_ID, ID.unique(), {
                        text,
                        user,
                        is_approved: false,
                        likes: 0,
                        liked_by: []
                    });
                    toggleForm(false);
                    showFormMessage("تم إرسال عبارتك للمراجعة. شكراً لك!");
                    cooldownManager.startCooldown();
                } catch (error) {
                    console.error("Failed to create phrase:", error);
                    validatePhrase(text, true, 'حدث خطأ غير متوقع. حاول مرة أخرى.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'إرسال';
                }
            };

            // ... validation functions, toggleForm, etc.

            // --- Initialisation ---
            async function initializePage() {
                anonymousUser = await getAnonymousUser();
                await loadAndApplySettings();
                await loadPhrases();
                sliderManager.init();
                cooldownManager.checkAndApply();
            }

            async function loadPhrases() {
                try {
                    const response = await databases.listDocuments(DATABASE_ID, PHRASES_COLLECTION_ID, [Query.equal('is_approved', true), Query.orderDesc("$createdAt")]);
                    phraseDocs = response.documents;
                    slider.innerHTML = '';
                    if (phraseDocs.length > 0) {
                        phraseDocs.forEach(doc => sliderManager.addCard(doc));
                    } else {
                        sliderManager.addCard({ text: 'لا توجد عبارات حالياً. كن أول من يضيف واحدة!', user: 'النظام', likes: 0, liked_by: [] });
                    }
                } catch (error) {
                    console.error("Failed to load phrases:", error);
                }
            }
            
            // ... all other functions from the previous version

            initializePage();
        });
    </script>
</body>
</html>
