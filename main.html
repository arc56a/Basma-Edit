<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ØµÙ…Ø© - Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <style>
        :root {
            --neon-blue: #0ff;
            --neon-pink: #ff2a6d;
            --dark-bg: #050814;
            --grid-color: rgba(0, 255, 255, 0.08);
            --fire-gradient: linear-gradient(0deg, #ff2a00, #ff8c00, #ff2a00);
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        img {
            -webkit-user-drag: none;
            user-drag: none;
            -webkit-touch-callout: none;
            user-select: none;
            pointer-events: none;
        }

        button,
        a {
            outline: none;
        }

        button:focus,
        button:active,
        a:focus {
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Tajawal', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-bg);
            color: #f5f5f5;
            position: relative;
            overflow-x: hidden;
        }

        body::before,
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            z-index: -2;
        }

        body::before {
            background:
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: gridMove 22s linear infinite;
        }

        body::after {
            background: radial-gradient(circle at 50% 120%, var(--fire-gradient) 0%, transparent 60%);
            filter: blur(18px);
            opacity: 0.55;
            animation: firePulse 4s ease-in-out infinite alternate;
        }

        .screen {
            min-height: 100vh;
            max-width: 480px;
            margin: 0 auto;
            padding: 16px 14px 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        header {
            position: sticky;
            top: 56px;
            z-index: 5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 14px;
            background: rgba(5, 10, 30, 0.85);
            border: 1px solid rgba(0, 255, 255, 0.35);
            box-shadow: 0 0 18px rgba(0, 255, 255, 0.3);
            text-align: center;
        }

        .logo {
            position: relative;
            font-weight: 700;
            letter-spacing: 2px;
            font-size: 1.1rem;
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
            z-index: 1;
        }

        .logo::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -10px;
            width: 32px;
            height: 32px;
            background: url('images/fingerprint.png') center/contain no-repeat;
            opacity: 0.25;
            filter: invert(1) brightness(1.3);
            pointer-events: none;
        }

        nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
        }

        nav button {
            border: 1px solid rgba(0, 255, 255, 0.4);
            border-radius: 999px;
            padding: 4px 8px;
            font-size: 0.7rem;
            background: rgba(5, 15, 35, 0.8);
            color: #e0e0e0;
            cursor: pointer;
            transition: 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        nav button:hover {
            border-color: var(--neon-pink);
            color: var(--neon-pink);
            box-shadow: 0 0 12px rgba(255, 42, 109, 0.7);
        }

        nav button.active {
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink));
            color: #050814;
            font-weight: 600;
            box-shadow: 0 0 18px rgba(0, 255, 255, 0.8), 0 0 28px rgba(255, 42, 109, 0.7);
        }

        nav button.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: -60%;
            width: 40%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255,255,255,0.6), transparent);
            opacity: 0.9;
            transform: skewX(-20deg);
            animation: tabShine 1.8s ease-in-out infinite;
        }

        .player-launcher {
            margin-top: 40px;
            display: flex;
            justify-content: center;
        }

        .player-launcher button {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 1px solid rgba(0, 255, 255, 0.7);
            background: radial-gradient(circle at 30% 0%, rgba(0,255,255,0.25), transparent 55%),
                        rgba(5, 10, 30, 0.95);
            box-shadow: 0 0 22px rgba(0, 255, 255, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
        }

        .player-launcher button:hover {
            transform: scale(1.06);
            border-color: var(--neon-pink);
            box-shadow: 0 0 26px rgba(255, 42, 109, 0.9);
        }

        .player-launcher img {
            width: 46px;
            height: 46px;
            object-fit: contain;
            filter: invert(1) drop-shadow(0 0 8px var(--neon-blue));
        }

        .player-launcher button.playing::after {
            content: 'â™ª';
            position: absolute;
            top: -10px;
            right: -6px;
            font-size: 1.1rem;
            color: var(--neon-pink);
            text-shadow: 0 0 6px var(--neon-pink);
            opacity: 0.9;
            animation: notesFloat 1.4s ease-in-out infinite;
        }

        .phrase-strip {
            margin-top: 24px;
            display: flex;
            justify-content: center;
            position: relative;
        }

        .phrase-strip.hidden {
            display: none;
        }

        .phrase-strip-inner {
            position: relative;
            width: 100%;
            max-width: 360px;
        }

        .phrase-chip {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 26px 24px;
            border-radius: 18px;
            background:
                radial-gradient(circle at 10% 0%, rgba(0, 77, 102, 0.7) 0, rgba(5, 8, 20, 0.85) 55%),
                radial-gradient(circle at 90% 100%, rgba(124, 18, 51, 0.7) 0, rgba(5, 8, 20, 0.9) 60%);
            border: 1px solid rgba(0, 255, 255, 0.4);
            box-shadow: 0 16px 30px rgba(0, 0, 0, 0.85);
            color: rgba(255,255,255,0.92);
            backdrop-filter: blur(6px);
            overflow: hidden;
            opacity: 0.95;
            transform-style: preserve-3d;
        }

        .phrase-chip span {
            max-width: 260px;
            text-align: center;
            line-height: 1.6;
        }

        .phrase-chip .icon-heart {
            margin-left: 6px;
            color: var(--neon-pink);
            font-size: 0.8rem;
            animation: heartFloat 1.8s ease-in-out infinite;
        }

        .floating-decor {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .floating-decor span {
            position: absolute;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.35);
            filter: drop-shadow(0 0 6px rgba(255,255,255,0.35));
            animation: floatDecor 6s ease-in-out infinite;
        }

        .floating-decor .heart1 { top: 8%;  left: 12%; animation-delay: 0s; }
        .floating-decor .heart2 { bottom: 10%; right: 18%; animation-delay: 1.2s; }
        .floating-decor .butter1 { top: 20%; right: 8%; animation-delay: 0.6s; }
        .floating-decor .butter2 { bottom: 18%; left: 20%; animation-delay: 1.8s; }

        /* Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .media-slider {
            margin: 20px auto 0;
            width: 100%;
            max-width: 320px;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 255, 0.4);
            box-shadow: 0 0 18px rgba(0, 255, 255, 0.3);
            background: rgba(5, 10, 30, 0.5);
            padding: 8px;
        }

        .media-slider-content {
            width: 100%;
            border-radius: 10px; /* A smaller radius for the inner content */
            overflow: hidden;
        }

        .media-slider-content img,
        .media-slider-content video {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            display: block;
        }

        .media-slider-footer {
            margin-top: 6px;
            font-size: 0.8rem;
            opacity: 0.85;
            text-align: center;
            color: var(--neon-blue);
        }

        /* Music Player Styles */
        .music-player {
            background: rgba(10, 20, 40, 0.75);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-top: 24px;
        }

        .music-player.active {
            display: flex;
        }

        .cover-container {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .cover-art {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            object-fit: cover;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.4);
            transition: box-shadow 0.5s ease;
            filter: invert(1) brightness(1.3) drop-shadow(0 0 8px var(--neon-blue));
        }

        .cover-art.playing {
            animation: pulse 2.5s infinite alternate;
        }

        @keyframes pulse {
            from { box-shadow: 0 0 25px rgba(0, 255, 255, 0.4); }
            to { box-shadow: 0 0 40px rgba(255, 42, 109, 0.7); }
        }

        .song-info h2 {
            margin: 10px 0 5px;
            font-size: 1.5rem;
            color: var(--neon-blue);
            text-shadow: 0 0 8px var(--neon-blue);
        }

        .song-info p {
            margin: 0;
            font-size: 1rem;
            color: #c0c0c0;
        }

        .progress-container {
            width: 100%;
            background-color: rgba(0,0,0,0.3);
            border-radius: 5px;
            cursor: pointer;
            height: 8px;
            margin-top: 10px;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--neon-pink);
            border-radius: 5px;
            transition: width 0.1s linear;
            box-shadow: 0 0 8px var(--neon-pink);
        }

        .time-display {
            width: 100%;
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #a0a0a0;
            margin-top: 5px;
        }

        .loop-controls {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #a0a0a0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .loop-controls select {
            background: rgba(5, 15, 35, 0.9);
            border-radius: 999px;
            border: 1px solid rgba(0, 255, 255, 0.4);
            color: #f5f5f5;
            font-size: 0.75rem;
            padding: 4px 10px;
            outline: none;
        }

        .back-btn,
        .exit-btn {
            position: fixed;
            top: 14px;
            min-width: 80px;
            height: 34px;
            padding: 0 10px;
            border-radius: 999px;
            border: 1px solid rgba(0, 255, 255, 0.4);
            background: rgba(5, 15, 35, 0.8);
            font-size: 0.75rem;
            color: #e0e0e0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            z-index: 10;
            transition: 0.25s ease;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.25);
        }

        .back-btn {
            right: 14px;
        }

        .exit-btn {
            left: 14px;
        }

        .back-btn:hover,
        .exit-btn:hover {
            border-color: var(--neon-pink);
            color: var(--neon-pink);
            box-shadow: 0 0 12px rgba(255, 42, 109, 0.7);
        }

        .back-btn img,
        .exit-btn img {
            width: 18px;
            height: 18px;
            object-fit: contain;
            filter: drop-shadow(0 0 5px var(--neon-blue));
            transform: scaleX(-1);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .control-btn {
            background: transparent;
            border: 1px solid rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: #fff;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: var(--neon-blue);
            transform: scale(1.1);
        }

        .control-btn.play-pause {
            width: 65px;
            height: 65px;
            font-size: 1.8rem;
            border-color: var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        .control-btn.play-pause:hover {
            box-shadow: 0 0 20px var(--neon-pink);
            border-color: var(--neon-pink);
        }
        
        @keyframes gridMove { 0% { background-position: 0 0; } 100% { background-position: 40px 40px; } }
        @keyframes firePulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.7; } }
        @keyframes tabShine { from { left: -60%; } to { left: 120%; } }

        @keyframes notesFloat {
            0% { transform: translate(0, 0) scale(0.9); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translate(-6px, -14px) scale(1.15); opacity: 0; }
        }

        @keyframes heartFloat {
            0% { transform: translateY(0) scale(1); opacity: 0.7; }
            50% { transform: translateY(-2px) scale(1.1); opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 0.7; }
        }

        @keyframes floatDecor {
            0% { transform: translateY(0) translateX(0) scale(0.9); opacity: 0; }
            20% { opacity: 0.6; }
            60% { transform: translateY(-6px) translateX(4px) scale(1.05); opacity: 0.9; }
            100% { transform: translateY(0) translateX(0) scale(0.9); opacity: 0; }
        }

        .phrase-chip.flip {
            animation: flipCard 0.6s ease-in-out;
        }

        @keyframes flipCard {
            0% { transform: rotateX(0deg); opacity: 1; }
            45% { transform: rotateX(90deg); opacity: 0; }
            55% { transform: rotateX(90deg); opacity: 0; }
            100% { transform: rotateX(0deg); opacity: 1; }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.history.back()"><img src="images/left-arrow.png" alt="Ø±Ø¬ÙˆØ¹"></button>
    <button class="exit-btn" onclick="window.location.href='index.html'"><img src="images/log-out.png" alt="Ø®Ø±ÙˆØ¬"></button>
    <div class="screen">
        <header>
            <div class="logo">Ø¨ØµÙ…Ø©</div>
            <nav>
                <button class="active" onclick="window.location.href='main.html'">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <button onclick="window.location.href='phrases.html'">Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª</button>
                <button onclick="window.location.href='updates.html'">Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</button>
                <button onclick="window.location.href='settings.html'">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <button onclick="window.location.href='about.html'">Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
            </nav>
        </header>

        <div class="player-launcher">
            <button id="open-player-btn" aria-label="ÙØªØ­ Ù…Ø´ØºÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰">
                <img src="images/headphones.png" alt="Ù…Ø´ØºÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰">
            </button>
        </div>

        <div class="phrase-strip" id="home-phrase-strip">
            <div class="phrase-strip-inner">
                <div class="phrase-chip">
                    <span id="home-phrase-text"></span>
                    <span class="icon-heart">â¤</span>
                    <div class="floating-decor">
                        <span class="heart1">â¤</span>
                        <span class="heart2">â¤</span>
                        <span class="butter1">ğŸ¦‹</span>
                        <span class="butter2">ğŸ¦‹</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ - Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© -->
        <div class="media-slider" id="mainMediaSlider">
            <div class="media-slider-content"></div>
        </div>

        <div class="media-slider-footer"></div>

        <div class="music-player" id="music-player">
            <div class="cover-container">
                <img src="images/headphones.png" alt="Cover Art" id="cover-art" class="cover-art">
            </div>
            <div class="song-info">
                <h2 id="song-title"></h2>
                <p id="song-artist"></p>
            </div>
            <div class="progress-container" id="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="time-display">
                <span id="current-time">0:00</span>
                <span id="duration">0:00</span>
            </div>
            <div class="controls">
                <button class="control-btn" id="prev-btn">â®</button>
                <button class="control-btn play-pause" id="play-pause-btn">â–¶</button>
                <button class="control-btn" id="next-btn">â­</button>
            </div>
            <div class="loop-controls">
                <span>Ù†Ù…Ø· Ø§Ù„ØªÙƒØ±Ø§Ø±:</span>
                <select id="loop-mode">
                    <option value="one">ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ø£ØºÙ†ÙŠØ©</option>
                    <option value="once">ØªØ´ØºÙŠÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                    <option value="list">Ù‚Ø§Ø¦Ù…Ø© Ù…ØªØªØ§Ø¨Ø¹Ø©</option>
                </select>
            </div>
            <audio id="audio-source"></audio>
        </div>
    </div>

    <script>
        const coverArt = document.getElementById('cover-art');
        const songTitle = document.getElementById('song-title');
        const songArtist = document.getElementById('song-artist');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const prevBtn = document.getElementById('prev-btn');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const nextBtn = document.getElementById('next-btn');
        const audio = document.getElementById('audio-source');
        const openPlayerBtn = document.getElementById('open-player-btn');
        const musicPlayerEl = document.getElementById('music-player');
        const loopModeSelect = document.getElementById('loop-mode');
        const homePhraseStrip = document.getElementById('home-phrase-strip');
        const homePhraseText = document.getElementById('home-phrase-text');
        const mainMediaSlider = document.getElementById('mainMediaSlider');
        const mediaSliderContent = document.querySelector('#mainMediaSlider .media-slider-content');
        const mediaSliderFooter = document.querySelector('.media-slider-footer');

        let songs = [];
        let songIndex = 0;
        let isPlaying = false;
        let loopMode = 'one';

        const APPWRITE_ENDPOINT = 'https://fra.cloud.appwrite.io/v1';
        const APPWRITE_PROJECT_ID = 'basmaedit56';
        const APPWRITE_DATABASE_ID = '693b73ab003790d00cf3';
        const MAIN_SECTION_COLLECTION_ID = 'main_section';
        const PHRASES_COLLECTION_ID = 'phrases_section'; // Added for phrases from the phrases collection

        let appwriteClient = null;
        let appwriteDatabases = null;

        if (window.Appwrite && window.Appwrite.Client) {
            try {
                appwriteClient = new window.Appwrite.Client()
                    .setEndpoint(APPWRITE_ENDPOINT)
                    .setProject(APPWRITE_PROJECT_ID);
                appwriteDatabases = new window.Appwrite.Databases(appwriteClient);
            } catch (e) {
                console.error('Failed to initialize Appwrite client:', e);
            }
        } else {
            console.warn('Appwrite SDK not loaded. Check CDN script.');
        }

        async function sendAppwritePing() {
            try {
                const res = await fetch(APPWRITE_ENDPOINT.replace(/\/$/, '') + '/health');
                const data = await res.json();
                console.log('Appwrite health response:', data);
                return data;
            } catch (error) {
                console.error('Error while pinging Appwrite:', error);
                throw error;
            }
        }

        async function loadMainSettingsForHome() {
            if (!appwriteDatabases) return;
            try {
                const response = await appwriteDatabases.listDocuments(
                    APPWRITE_DATABASE_ID,
                    MAIN_SECTION_COLLECTION_ID
                );

                if (response.total > 0) {
                    const doc = response.documents[0];
                    console.log('Main settings document:', doc); // Log the fetched document

                    // Ø²Ø± Ù…Ø´ØºÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
                    if (openPlayerBtn && openPlayerBtn.parentElement) {
                        const musicVisible = typeof doc.music_button_visible === 'boolean' ? doc.music_button_visible : true;
                        openPlayerBtn.parentElement.style.display = musicVisible ? 'flex' : 'none';
                    }

                    // Ø¨Ø·Ø§Ù‚Ø§Øª / Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª
                    if (homePhraseStrip) {
                        const phrasesVisible = typeof doc.phrases_cards_visible === 'boolean' ? doc.phrases_cards_visible : true;
                        homePhraseStrip.style.display = phrasesVisible ? 'flex' : 'none';
                    }

                    // Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ÙˆØ§Ù„ØµÙˆØ±Ø©/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø£Ø®ÙˆØ°Ø© Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø³Ø¬Ù„
                    if (mainMediaSlider) {
                        const sliderVisible = typeof doc.slider_visible === 'boolean' ? doc.slider_visible : true;
                        console.log('slider_visible from doc:', doc.slider_visible); // Log raw value
                        console.log('calculated sliderVisible:', sliderVisible);     // Log calculated value
                        mainMediaSlider.style.display = sliderVisible ? 'block' : 'none';
                        if (mediaSliderFooter) {
                            mediaSliderFooter.style.display = sliderVisible ? 'block' : 'none';
                        }

                        if (sliderVisible && mediaSliderContent) {
                            const url = doc.slider_media_url || '';
                            const title = doc.slider_title || '';
                            
                            mediaSliderContent.innerHTML = '';

                            if (url) {
                                // Basic check for video URLs
                                if (url.match(/\.(mp4|webm|ogg)$/i)) {
                                    const videoEl = document.createElement('video');
                                    videoEl.src = url;
                                    videoEl.controls = true;
                                    videoEl.style.width = '100%';
                                    videoEl.style.display = 'block';
                                    mediaSliderContent.appendChild(videoEl);
                                } else {
                                    const imgEl = document.createElement('img');
                                    imgEl.src = url;
                                    imgEl.alt = title || 'ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±';
                                    mediaSliderContent.appendChild(imgEl);
                                }
                            }

                            if (mediaSliderFooter) {
                                mediaSliderFooter.textContent = title || '';
                            }
                        }
                    }
                } else {
                    console.warn("No settings document found for main section. Defaulting to visible.");
                    // In case no settings are found, default to visible
                    if (openPlayerBtn && openPlayerBtn.parentElement) {
                        openPlayerBtn.parentElement.style.display = 'flex';
                    }
                    if (homePhraseStrip) {
                        homePhraseStrip.style.display = 'block';
                    }
                    if (mainMediaSlider) {
                        mainMediaSlider.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© main_section ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:', error);
                // Ensure visibility is reset even on error
                if (openPlayerBtn && openPlayerBtn.parentElement) {
                    openPlayerBtn.parentElement.style.display = 'flex';
                }
                if (homePhraseStrip) {
                    homePhraseStrip.style.display = 'block';
                }
                if (mainMediaSlider) {
                    mainMediaSlider.style.display = 'block';
                }
            }
        }

        // Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØºØ§Ù†ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Appwrite Ø£Ùˆ ØºÙŠØ±Ù‡)
        let homePhrases = []; // This array will store the fetched phrases
        let homePhraseIndex = 0;
        let phraseRotationInterval; // To hold the interval ID

        function loadSong(song) {
            if (!song || !song.src) {
                return;
            }
            songTitle.textContent = song.title;
            songArtist.textContent = song.artist;
            audio.src = song.src;
            coverArt.src = song.cover;
        }

        function rotateHomePhrase() {
            if (!homePhraseStrip || !homePhraseText || homePhrases.length === 0) return; // Added check for empty homePhrases

            const card = homePhraseText.closest('.phrase-chip');
            if (!card) return;

            card.classList.add('flip');

            // ØºÙŠÙ‘Ø± Ø§Ù„Ù†Øµ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø§Ù†Ù‚Ù„Ø§Ø¨ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
            setTimeout(() => {
                homePhraseIndex = (homePhraseIndex + 1) % homePhrases.length;
                homePhraseText.textContent = homePhrases[homePhraseIndex];
            }, 260);

            // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ø§Ø³ Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
            setTimeout(() => {
                card.classList.remove('flip');
            }, 620);
        }

        async function loadPhrasesForMain() {
            if (!appwriteDatabases) {
                console.error('Appwrite Databases not initialized.');
                homePhrases.push('Ø®Ø·Ø£: ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª.'); // Default error message
                homePhraseText.textContent = homePhrases[0];
                return;
            }
            try {
                const response = await appwriteDatabases.listDocuments(
                    APPWRITE_DATABASE_ID,
                    PHRASES_COLLECTION_ID,
                    [
                        window.Appwrite.Query.equal('is_approved', true),
                        window.Appwrite.Query.orderDesc('$createdAt'),
                        window.Appwrite.Query.limit(100) // Limit to a reasonable number for rotation
                    ]
                );

                if (response.documents.length > 0) {
                    response.documents.forEach(doc => homePhrases.push(doc.text));
                    homePhraseText.textContent = homePhrases[homePhraseIndex]; // Display the first phrase
                    if (homePhrases.length > 1) { // Only start rotation if there's more than one phrase
                        phraseRotationInterval = setInterval(rotateHomePhrase, 4000); // Start rotation
                    }
                } else {
                    homePhrases.push('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø¨Ø§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.'); // Default message
                    homePhraseText.textContent = homePhrases[0];
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:', error);
                homePhrases.push('Ø®Ø·Ø£: ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª.'); // Default error message
                homePhraseText.textContent = homePhrases[0];
            }
        }
        
        function playSong() {
            isPlaying = true;
            playPauseBtn.innerHTML = 'â¸';
            coverArt.classList.add('playing');
            openPlayerBtn.classList.add('playing');
            audio.play();
        }

        function pauseSong() {
            isPlaying = false;
            playPauseBtn.innerHTML = 'â–¶';
            coverArt.classList.remove('playing');
            openPlayerBtn.classList.remove('playing');
            audio.pause();
        }

        function prevSong() {
            if (!songs || songs.length === 0) return;
            songIndex--;
            if (songIndex < 0) {
                songIndex = songs.length - 1;
            }
            loadSong(songs[songIndex]);
            playSong();
        }

        function nextSong() {
            if (!songs || songs.length === 0) return;
            songIndex++;
            if (songIndex > songs.length - 1) {
                songIndex = 0;
            }
            loadSong(songs[songIndex]);
            playSong();
        }
        
        function handleSongEnd() {
            if (!songs || songs.length === 0) {
                pauseSong();
                audio.currentTime = 0;
                return;
            }
            if (loopMode === 'one') {
                audio.currentTime = 0;
                playSong();
            } else if (loopMode === 'once') {
                pauseSong();
                audio.currentTime = 0;
            } else if (loopMode === 'list') {
                nextSong();
            }
        }
        
        function updateProgress(e) {
            const { duration, currentTime } = e.srcElement;
            if (duration) {
                const progressPercent = (currentTime / duration) * 100;
                progressBar.style.width = `${progressPercent}%`;

                const formatTime = (time) => String(Math.floor(time)).padStart(2, '0');
                
                const durationMinutes = Math.floor(duration / 60);
                const durationSeconds = formatTime(duration % 60);
                durationEl.textContent = `${durationMinutes}:${durationSeconds}`;

                const currentMinutes = Math.floor(currentTime / 60);
                const currentSeconds = formatTime(currentTime % 60);
                currentTimeEl.textContent = `${currentMinutes}:${currentSeconds}`;
            }
        }

        function setProgress(e) {
            const width = this.clientWidth;
            const clickX = e.offsetX;
            const duration = audio.duration;
            if (duration) {
                audio.currentTime = (clickX / width) * duration;
            }
        }

        openPlayerBtn.addEventListener('click', () => {
            const isActive = musicPlayerEl.classList.contains('active');
            if (isActive) {
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø´ØºÙ„ ÙÙ‚Ø·ØŒ Ù…Ø¹ Ø¨Ù‚Ø§Ø¡ Ø§Ù„ØµÙˆØª ÙˆØ§Ù„ØªØ£Ø«ÙŠØ± ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† ÙŠØ¹Ù…Ù„
                musicPlayerEl.classList.remove('active');
                if (homePhraseStrip) {
                    homePhraseStrip.classList.remove('hidden');
                }
            } else {
                musicPlayerEl.classList.add('active');
                if (homePhraseStrip) {
                    homePhraseStrip.classList.add('hidden');
                }
            }
        });

        playPauseBtn.addEventListener('click', () => {
            (isPlaying ? pauseSong : playSong)();
        });

        prevBtn.addEventListener('click', prevSong);
        nextBtn.addEventListener('click', nextSong);
        audio.addEventListener('timeupdate', updateProgress);
        audio.addEventListener('loadedmetadata', updateProgress); // Update time when metadata loads
        progressContainer.addEventListener('click', setProgress);
        audio.addEventListener('ended', handleSongEnd);

        loopModeSelect.addEventListener('change', (e) => {
            loopMode = e.target.value;
        });

        // Initial load (Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØºØ§Ù†ÙŠ Ø­ØªÙ‰ ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        if (songs && songs.length > 0) {
            loadSong(songs[songIndex]);
        } else {
            songTitle.textContent = '';
            songArtist.textContent = '';
        }

        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„ØµÙØ­Ø© (Ù‚Ø¯ ÙŠÙ…Ù†Ø¹Ù‡ Ø§Ù„Ù…ØªØµÙØ­ Ø­ØªÙ‰ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„)
        window.addEventListener('load', async () => {
            try {
                playSong();
            } catch (e) {
                // Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ØªÙ…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„ØµÙˆØª Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            }
            if (homePhraseStrip && !musicPlayerEl.classList.contains('active')) {
                homePhraseStrip.classList.remove('hidden');
            }
            await loadMainSettingsForHome(); // Await settings to ensure visibility is set before loading phrases
            await loadPhrasesForMain(); // Call the new function to load phrases
        });

        // Removed: setInterval(rotateHomePhrase, 4000); // Will now be called inside loadPhrasesForMain
    </script>
</body>
</html>